<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reconciliation Tool (Separate Files & Custom Reports)</title>
    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Load Babel for JSX transpilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS/XLSX for Excel file handling -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.5rem;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
    // Destructure hooks from the global React object for easy access
    const { useState, useEffect, useCallback, useMemo } = React;
    
    // --- ICON PLACEHOLDERS (Using simple SVG or Unicode for single-file HTML) ---
    const IconWrapper = ({ children, size = 20, className = '', color = 'currentColor' }) => (
        <span className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', color: color }}>{children}</span>
    );
    const Upload = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg></IconWrapper>;
    const FileSpreadsheet = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h12"/><path d="M8 17h12"/><path d="M4 17h.01"/><path d="M4 13h.01"/></svg></IconWrapper>;
    const CheckCircle = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg></IconWrapper>;
    const Info = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></IconWrapper>;
    const Download = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></IconWrapper>;
    const DownloadCloud = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.5v1.5a2.5 2.5 0 0 0 2.5 2.5h10.3"/><path d="m16 16 3-3-3-3"/><path d="M16 13h-3"/></svg></IconWrapper>;
    const DollarSign = (props) => <IconWrapper {...props}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></IconWrapper>;

    
    // --- UTILITIES ---

    // New helper function for robust ID serialization
    const serializeId = (id) => String(id).trim().toUpperCase();

    // Helper to convert string to array buffer for XLSX
    const s2ab = (s) => {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    };

    // Modified download function to handle a single report object and create a single file
    const downloadExcel = (report) => {
        if (!report || (!report.isSummary && report.data.length === 0)) {
            console.error('No data or report definition provided for download.');
            return;
        }

        const workbook = XLSX.utils.book_new();

        if (report.isSummary) {
            // Summary report requires two sheets: one for A and one for B summary
            // report.data is an object: { 'File A Summary': [...], 'File B Summary': [...] }
            for (const sheetName in report.data) {
                const sheetData = report.data[sheetName];
                const worksheet = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
            }
        } else {
            // Standard data report (Matched/Unmatched)
            const worksheet = XLSX.utils.json_to_sheet(report.data);
            // Use the report name as the sheet name
            XLSX.utils.book_append_sheet(workbook, worksheet, report.name);
        }

        // Write the workbook to a file
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });

        // Create a Blob and initiate download
        const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = report.fileName; // Use the specific filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- COMPONENTS ---

    // Component for file upload
    const FileUploader = ({ file, setFile, title, onParse, loading }) => {
        const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
                setFile(prev => ({ ...prev, name: file.name }));
                onParse(file, title);
            }
        };

        const handleRemove = () => {
            setFile({ name: null, headers: [], data: [], idCol: null, amountCol: null });
        };

        return (
            <div className="flex-1 bg-white p-6 rounded-xl shadow-md border-2 border-dashed border-gray-300 transition duration-300 hover:border-indigo-500 relative">
                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <FileSpreadsheet size={20} className="mr-2 text-indigo-600" />
                    {title} File ({file.name ? 'Loaded' : 'Required'})
                </h3>
                {file.name ? (
                    <div className="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <span className="text-sm font-medium text-green-800 truncate">
                            <CheckCircle size={16} className="inline mr-1 text-green-600" />
                            {file.name}
                        </span>
                        <button 
                            onClick={handleRemove} 
                            className="ml-4 text-red-500 hover:text-red-700 text-sm font-semibold"
                        >
                            Remove
                        </button>
                    </div>
                ) : (
                    <label className="flex flex-col items-center justify-center p-8 text-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition duration-200">
                        <Upload size={32} className="text-gray-500 mb-2" />
                        <span className="text-sm font-semibold text-gray-700">Click to upload (.xlsx, .csv)</span>
                        <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileChange} disabled={loading} className="hidden" />
                    </label>
                )}
            </div>
        );
    };

    // Component for column selection (Step 2)
    const ColumnSelector = ({ file, setFile, category, loading }) => {
        const handleIdChange = (e) => setFile(prev => ({ ...prev, idCol: e.target.value }));
        const handleAmountChange = (e) => setFile(prev => ({ ...prev, amountCol: e.target.value }));

        if (!file.name) return null;

        return (
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">{category} - Select Columns</h3>
                <div className="space-y-4">
                    {/* ID Column Selection */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Matching ID Column <span className="text-red-500">*</span>
                        </label>
                        <select
                            value={file.idCol || ''}
                            onChange={handleIdChange}
                            disabled={loading}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="">-- Select ID Column --</option>
                            {file.headers.map(header => (
                                <option key={header} value={header}>{header}</option>
                            ))}
                        </select>
                        <p className="text-xs text-gray-500 mt-1">This column will be used for reconciliation.</p>
                    </div>
                    
                    {/* Amount Column Selection */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Amount Column (For Summary)
                        </label>
                        <select
                            value={file.amountCol || ''}
                            onChange={handleAmountChange}
                            disabled={loading}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="">-- Select Amount Column (Optional) --</option>
                            {file.headers.map(header => (
                                <option key={header} value={header}>{header}</option>
                            ))}
                        </select>
                        <p className="text-xs text-gray-500 mt-1">This column will be summed up for the report summary.</p>
                    </div>
                </div>
            </div>
        );
    };

    // Component for displaying Summary Metrics (Step 3)
    const SummaryTable = ({ metrics, category }) => (
        <div className="p-4 bg-white border border-gray-200 rounded-xl shadow-sm h-full">
            <h4 className="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">{category} Metrics</h4>
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                        <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200 text-sm">
                    {metrics.map((item) => (
                        <tr key={item.label} className={item.label === 'Consolidated Total' ? 'bg-indigo-50 font-bold text-indigo-700' : ''}>
                            <td className="px-3 py-2 whitespace-nowrap">{item.label}</td>
                            <td className="px-3 py-2 whitespace-nowrap">{item.count.toLocaleString()}</td>
                            <td className="px-3 py-2 whitespace-nowrap text-right">
                                {new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(item.amount)}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );

    // --- MAIN APP COMPONENT ---

    const ReconciliationApp = () => {
        const [step, setStep] = useState(1);
        const [fileDataA, setFileDataA] = useState({ name: null, headers: [], data: [], idCol: null, amountCol: null });
        const [fileDataB, setFileDataB] = useState({ name: null, headers: [], data: [], idCol: null, amountCol: null });
        const [loading, setLoading] = useState(false);
        const [message, setMessage] = useState(null);
        const [results, setResults] = useState(null);
        const [selectedDownloads, setSelectedDownloads] = useState([]); // State for selected reports

        const isValidStep2 = fileDataA.idCol && fileDataB.idCol;

        // Helper function to read and parse the file
        const parseFile = (file, category) => {
            setLoading(true);
            setMessage(null);
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON array
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (json.length === 0) {
                        setMessage({ type: 'error', text: `File ${file.name} is empty.` });
                        return;
                    }
                    
                    // First row is headers
                    const headers = json[0];
                    // Rest are data rows
                    const dataRows = json.slice(1).map((row) => {
                        const rowObject = {};
                        headers.forEach((header, index) => {
                            // Ensure all headers are strings and normalize data values (especially for large numbers/IDs)
                            rowObject[String(header).trim()] = String(row[index] ?? ''); 
                        });
                        return rowObject;
                    }).filter(row => Object.values(row).some(val => val !== '')); // Filter out completely empty rows
                    
                    const setFile = category === 'Category A' ? setFileDataA : setFileDataB;
                    setFile(prev => ({ 
                        ...prev, 
                        headers: headers.map(h => String(h).trim()), 
                        data: dataRows, 
                    }));

                    setMessage({ type: 'success', text: `${category} file loaded successfully.` });
                } catch (error) {
                    console.error("Error parsing file:", error);
                    setMessage({ type: 'error', text: `Failed to parse file ${file.name}. Ensure it is a valid Excel/CSV format.` });
                } finally {
                    setLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        // Helper function for calculating metrics
        const calculateMetrics = (data, amountCol) => {
            const totalCount = data.length;
            const totalAmount = data.reduce((sum, row) => sum + (parseFloat(row[amountCol]) || 0), 0);
            return { count: totalCount, amount: totalAmount };
        };

        // CORE RECONCILIATION LOGIC
        const handleReconcile = useCallback(() => {
            if (!fileDataA.data.length || !fileDataB.data.length || !fileDataA.idCol || !fileDataB.idCol) {
                setMessage({ type: 'error', text: 'Please upload both files and select the mandatory ID columns.' });
                return;
            }

            setLoading(true);
            setMessage({ type: 'info', text: 'Reconciling data...' });

            // 1. Calculate Composite IDs and Appearance Count for A
            const idCountsA = {};
            const processedDataA = fileDataA.data.map((row, index) => {
                // ID Serialization/Normalization (step 1 requested)
                const compositeId = serializeId(row[fileDataA.idCol]);

                idCountsA[compositeId] = (idCountsA[compositeId] || 0) + 1;

                return {
                    ...row,
                    __Composite_ID: compositeId,
                    __Source_File: fileDataA.name,
                    __Original_Row_Index: index + 2, // 1-based index + header row
                };
            });

            // Finalize Appearance Count for A
            const finalDataA = processedDataA.map(row => ({
                ...row,
                Appearance_Count: idCountsA[row.__Composite_ID],
            }));


            // 2. Calculate Composite IDs and Appearance Count for B
            const idCountsB = {};
            const processedDataB = fileDataB.data.map((row, index) => {
                // ID Serialization/Normalization (step 1 requested)
                const compositeId = serializeId(row[fileDataB.idCol]);

                idCountsB[compositeId] = (idCountsB[compositeId] || 0) + 1;

                return {
                    ...row,
                    __Composite_ID: compositeId,
                    __Source_File: fileDataB.name,
                    __Original_Row_Index: index + 2,
                };
            });

            // Finalize Appearance Count for B
            const finalDataB = processedDataB.map(row => ({
                ...row,
                Appearance_Count: idCountsB[row.__Composite_ID],
            }));

            // 3. Matching Logic
            const matchedAIds = new Set();
            
            // Create Map for File B lookup (using Composite_ID as key for faster lookup)
            const mapB = new Map();
            finalDataB.forEach(row => {
                // Store all rows for a given ID as an array
                if (!mapB.has(row.__Composite_ID)) {
                    mapB.set(row.__Composite_ID, []);
                }
                mapB.get(row.__Composite_ID).push(row);
            });

            // Perform matching from A to B
            const matchedA = [];
            const unmatchedA = [];
            
            finalDataA.forEach(rowA => {
                if (mapB.has(rowA.__Composite_ID)) {
                    matchedA.push(rowA);
                    matchedAIds.add(rowA.__Composite_ID);
                } else {
                    unmatchedA.push(rowA);
                }
            });
            
            // Perform matching from B to A (to find unmatched B)
            const matchedB = [];
            const unmatchedB = [];

            finalDataB.forEach(rowB => {
                // Use a Set for faster lookup of IDs that were matched from A
                if (matchedAIds.has(rowB.__Composite_ID)) {
                    matchedB.push(rowB);
                } else {
                    unmatchedB.push(rowB);
                }
            });

            // 4. Data Projection (Step 4 & 5 requested)
            // Define meta headers to be included in all reports
            const metaHeaders = ['__Composite_ID', 'Appearance_Count', '__Source_File', '__Original_Row_Index'];
            
            // Function to create projected data (only original headers + meta headers)
            const projectData = (data, originalHeaders) => {
                const projectionHeaders = [...metaHeaders, ...originalHeaders];
                return data.map(row => {
                    const newRow = {};
                    projectionHeaders.forEach(header => {
                        newRow[header] = row[header];
                    });
                    return newRow;
                });
            };
            
            // Generate projected reports for A and B
            const reports = {
                matchedA: projectData(matchedA, fileDataA.headers),
                unmatchedA: projectData(unmatchedA, fileDataA.headers),
                matchedB: projectData(matchedB, fileDataB.headers),
                unmatchedB: projectData(unmatchedB, fileDataB.headers),
            };


            // 5. Summary Metrics (Step 6 requested)
            
            // Consolidated A Metrics
            const metricsA_All = calculateMetrics(finalDataA, fileDataA.amountCol);
            const metricsA_Matched = calculateMetrics(matchedA, fileDataA.amountCol);
            const metricsA_Unmatched = calculateMetrics(unmatchedA, fileDataA.amountCol);

            const summaryMetricsA = [
                { label: 'Consolidated Total', count: metricsA_All.count, amount: metricsA_All.amount },
                { label: 'Total Matched', count: metricsA_Matched.count, amount: metricsA_Matched.amount },
                { label: 'Total Unmatched', count: metricsA_Unmatched.count, amount: metricsA_Unmatched.amount },
            ];

            // Consolidated B Metrics
            const metricsB_All = calculateMetrics(finalDataB, fileDataB.amountCol);
            const metricsB_Matched = calculateMetrics(matchedB, fileDataB.amountCol);
            const metricsB_Unmatched = calculateMetrics(unmatchedB, fileDataB.amountCol);

            const summaryMetricsB = [
                { label: 'Consolidated Total', count: metricsB_All.count, amount: metricsB_All.amount },
                { label: 'Total Matched', count: metricsB_Matched.count, amount: metricsB_Matched.amount },
                { label: 'Total Unmatched', count: metricsB_Unmatched.count, amount: metricsB_Unmatched.amount },
            ];

            // 6. Final Results Structure for Download (Separate Files/Selective Download)
            const allReports = [
                { 
                    name: 'Summary Report', 
                    fileName: 'Reconciliation_Summary_Report.xlsx',
                    data: { 
                        'File A Summary': summaryMetricsA.map(m => ({
                            Category: m.label,
                            Count: m.count,
                            Amount: m.amount,
                        })),
                        'File B Summary': summaryMetricsB.map(m => ({
                            Category: m.label,
                            Count: m.count,
                            Amount: m.amount,
                        })),
                    },
                    isSummary: true
                },
                { 
                    name: 'Matched - File A', 
                    fileName: 'Matched_A_Transactions.xlsx', 
                    data: reports.matchedA, 
                    isSummary: false 
                },
                { 
                    name: 'Unmatched - File A', 
                    fileName: 'Unmatched_A_Transactions.xlsx', 
                    data: reports.unmatchedA, 
                    isSummary: false 
                },
                { 
                    name: 'Matched - File B', 
                    fileName: 'Matched_B_Transactions.xlsx', 
                    data: reports.matchedB, 
                    isSummary: false 
                },
                { 
                    name: 'Unmatched - File B', 
                    fileName: 'Unmatched_B_Transactions.xlsx', 
                    data: reports.unmatchedB, 
                    isSummary: false 
                },
            ];

            setResults({
                allReports, // New structure to hold all 5 reports
                summaryMetricsA,
                summaryMetricsB,
                matchedCount: metricsA_Matched.count,
                unmatchedACount: metricsA_Unmatched.count,
                unmatchedBCount: metricsB_Unmatched.count,
            });
            setLoading(false);
            setStep(3);
            setMessage({ type: 'success', text: 'Reconciliation complete! Review the summary and download your reports.' });

        }, [fileDataA, fileDataB]);

        // Function to handle multiple downloads
        const handleDownloadSelected = () => {
            if (!results || selectedDownloads.length === 0) return;

            // Simple loop to download selected reports individually
            selectedDownloads.forEach(reportName => {
                const report = results.allReports.find(r => r.name === reportName);
                if (report) {
                    downloadExcel(report);
                }
            });
            setMessage({ type: 'success', text: `Successfully generated and downloaded ${selectedDownloads.length} report(s). Check your downloads folder.` });
        };

        // --- RENDER LOGIC ---

        return (
            <div className="p-4 sm:p-8 bg-gray-50 min-h-screen">
                <div className="max-w-7xl mx-auto">
                    <header className="text-center mb-10 bg-white p-6 rounded-xl shadow-lg">
                        <h1 className="text-3xl font-extrabold text-indigo-700">Advanced Reconciliation Tool</h1>
                        <p className="text-gray-600 mt-2">Match and report differences between two financial datasets.</p>
                        <div className="flex justify-center space-x-4 mt-4 text-sm font-medium">
                            <span className={`px-4 py-2 rounded-full ${step === 1 ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-200 text-gray-600'}`}>1. Upload Files</span>
                            <span className={`px-4 py-2 rounded-full ${step === 2 ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-200 text-gray-600'}`}>2. Select Columns</span>
                            <span className={`px-4 py-2 rounded-full ${step === 3 ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-200 text-gray-600'}`}>3. Review & Download</span>
                        </div>
                    </header>
                    
                    {/* Message Area */}
                    {message && (
                        <div className={`p-4 mb-6 rounded-lg font-medium ${
                            message.type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' : 
                            message.type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 
                            'bg-blue-100 text-blue-800 border border-blue-300'
                        }`}>
                            {message.text}
                        </div>
                    )}

                    <div className="relative bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
                        {loading && (
                            <div className="loading-overlay">
                                <div className="flex flex-col items-center">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                                    <p className="mt-4 text-indigo-600 font-semibold">Processing...</p>
                                </div>
                            </div>
                        )}

                        {/* STEP 1: UPLOAD */}
                        {step === 1 && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row gap-6">
                                    <FileUploader 
                                        file={fileDataA} 
                                        setFile={setFileDataA} 
                                        title="Category A (Source File)" 
                                        onParse={parseFile}
                                        loading={loading}
                                    />
                                    <FileUploader 
                                        file={fileDataB} 
                                        setFile={setFileDataB} 
                                        title="Category B (Comparison File)" 
                                        onParse={parseFile}
                                        loading={loading}
                                    />
                                </div>
                                <div className="text-center pt-4">
                                    <button 
                                        onClick={() => setStep(2)} 
                                        disabled={!fileDataA.name || !fileDataB.name || loading}
                                        className={`w-full md:w-auto px-8 py-3 rounded-full font-bold text-white transition duration-300 ease-in-out shadow-lg ${
                                            !fileDataA.name || !fileDataB.name || loading 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 transform hover:scale-105'
                                        }`}
                                    >
                                        Next: Select Columns
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 2: COLUMN SELECTION & RUN */}
                        {step === 2 && (
                            <div className="space-y-8">
                                <div className="grid md:grid-cols-2 gap-6">
                                    <ColumnSelector 
                                        file={fileDataA} 
                                        setFile={setFileDataA} 
                                        category="Category A" 
                                        loading={loading} 
                                    />
                                    <ColumnSelector 
                                        file={fileDataB} 
                                        setFile={setFileDataB} 
                                        category="Category B" 
                                        loading={loading} 
                                    />
                                </div>
                                
                                <div className="flex justify-between items-center pt-4">
                                    <button 
                                        onClick={() => setStep(1)} 
                                        className="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-100 transition duration-200"
                                    >
                                        &larr; Back to Upload
                                    </button>
                                    <button 
                                        onClick={handleReconcile} 
                                        disabled={!isValidStep2 || loading}
                                        className={`px-8 py-3 rounded-full font-bold text-white transition duration-300 ease-in-out shadow-lg ${
                                            !isValidStep2 || loading 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-green-600 hover:bg-green-700 active:bg-green-800 transform hover:scale-105'
                                        }`}
                                    >
                                        Run Reconciliation
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 3: RESULTS & DOWNLOAD */}
                        {step === 3 && results && (
                            <div className="space-y-8">
                                {/* Key Metrics Section */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                    <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-lg">
                                        <h4 className="text-sm font-semibold text-indigo-600 uppercase">Matched Records (ID Count)</h4>
                                        <p className="text-3xl font-extrabold text-indigo-800 mt-1">{results.matchedCount.toLocaleString()}</p>
                                    </div>
                                    <div className="bg-red-50 p-6 rounded-xl border border-red-200 shadow-lg">
                                        <h4 className="text-sm font-semibold text-red-600 uppercase">Unmatched in File A</h4>
                                        <p className="text-3xl font-extrabold text-red-800 mt-1">{results.unmatchedACount.toLocaleString()}</p>
                                    </div>
                                    <div className="bg-yellow-50 p-6 rounded-xl border border-yellow-200 shadow-lg">
                                        <h4 className="text-sm font-semibold text-yellow-600 uppercase">Unmatched in File B</h4>
                                        <p className="text-3xl font-extrabold text-yellow-800 mt-1">{results.unmatchedBCount.toLocaleString()}</p>
                                    </div>
                                </div>

                                {/* Structured Summary Tables */}
                                <div className="bg-gray-50 rounded-xl p-6 shadow-inner">
                                    <h3 className="font-bold text-xl mb-4 text-gray-800 border-b pb-2 flex items-center">
                                        <DollarSign size={20} className="mr-2 text-indigo-600"/> Detailed Structured Summary
                                    </h3>
                                    <div className="grid md:grid-cols-2 gap-6">
                                        {/* Category A Summary */}
                                        <SummaryTable metrics={results.summaryMetricsA} category={`Category A (${fileDataA.name})`} />
                                        
                                        {/* Category B Summary */}
                                        <SummaryTable metrics={results.summaryMetricsB} category={`Category B (${fileDataB.name})`} />
                                    </div>
                                </div>
                                
                                {/* Download Selection Area (New implementation for separate files) */}
                                <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                        <DownloadCloud size={20} className="mr-2 text-indigo-600" />
                                        Select Reports for Download
                                    </h3>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                                        {results.allReports.map((report) => (
                                            <label 
                                                key={report.name} 
                                                className="flex flex-col items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer transition duration-150 hover:bg-indigo-50 hover:border-indigo-400"
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDownloads.includes(report.name)}
                                                    onChange={(e) => {
                                                        setSelectedDownloads(prev => 
                                                            e.target.checked
                                                                ? [...prev, report.name]
                                                                : prev.filter(n => n !== report.name)
                                                        );
                                                    }}
                                                    className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                                />
                                                <span className="mt-1 text-xs font-medium text-gray-700 text-center">{report.name}</span>
                                            </label>
                                        ))}
                                    </div>

                                    <div className="mt-6 text-center">
                                        <button
                                            onClick={handleDownloadSelected}
                                            disabled={selectedDownloads.length === 0}
                                            className={`px-8 py-3 rounded-full font-bold text-white transition duration-300 ease-in-out shadow-lg transform hover:scale-105 ${
                                                selectedDownloads.length === 0 
                                                ? 'bg-gray-400 cursor-not-allowed' 
                                                : 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800'
                                            }`}
                                        >
                                            <Download size={20} className="inline mr-2" />
                                            Download {selectedDownloads.length} Report{selectedDownloads.length !== 1 ? 's' : ''}
                                        </button>
                                    </div>
                                </div>

                                {/* Info/Reset Area */}
                                <div className="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                                    <p className="text-sm text-blue-800 flex items-start">
                                        <Info size={18} className="mr-2 mt-0.5 flex-shrink-0 text-blue-600" />
                                        <span>
                                            **Traceability Note:** All generated data files include essential metadata: **`__Composite_ID`** (the key used for matching), **`Appearance_Count`** (how many times the ID appeared in its source file), **`__Source_File`**, and **`__Original_Row_Index`** (the row number in the source file) to help you trace the transaction back to its origin.
                                        </span>
                                    </p>
                                </div>

                                <div className="text-center pt-4">
                                    <button 
                                        onClick={() => { setStep(1); setResults(null); setFileDataA({ name: null, headers: [], data: [], idCol: null, amountCol: null }); setFileDataB({ name: null, headers: [], data: [], idCol: null, amountCol: null }); }} 
                                        className="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-200"
                                    >
                                        Start New Reconciliation
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // Render the React application
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<ReconciliationApp />);

    </script>
</body>
</html>
