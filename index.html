<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reconciliation Tool (Layered ID Extraction)</title>
    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Load Babel for JSX transpilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS/XLSX for Excel file handling -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
    // Destructure hooks from the global React object for easy access (FIX: addresses ReferenceError: useState is not defined)
    const { useState, useEffect, useCallback, useMemo } = React;
    
    // --- ICON PLACEHOLDERS (Replacing lucide-react imports for single-file HTML) ---
    // Using simple characters/emojis as a fallback for lucide-react icons in the single HTML file environment.
    const IconWrapper = ({ children, size = 20, className = '', color = 'currentColor' }) => (
        <span className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', color: color }}>{children}</span>
    );
    const Upload = (props) => <IconWrapper {...props}><span role="img" aria-label="Upload">‚§í</span></IconWrapper>;
    const FileSpreadsheet = (props) => <IconWrapper {...props}><span role="img" aria-label="Spreadsheet">üóÇÔ∏è</span></IconWrapper>;
    const AlertCircle = (props) => <IconWrapper {...props}><span role="img" aria-label="Alert">‚ö†Ô∏è</span></IconWrapper>;
    const CheckCircle = (props) => <IconWrapper {...props}><span role="img" aria-label="Check">‚úÖ</span></IconWrapper>;
    const Download = (props) => <IconWrapper {...props}><span role="img" aria-label="Download">‚¨áÔ∏è</span></IconWrapper>;
    const X = (props) => <IconWrapper {...props}><span role="img" aria-label="Close">‚ùå</span></IconWrapper>;
    const Info = (props) => <IconWrapper {...props}><span role="img" aria-label="Info">‚ÑπÔ∏è</span></IconWrapper>;


    // --- UTILITY FUNCTIONS ---

    // Utility for retrying fetch requests with exponential backoff
    const fetchWithRetry = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (i < retries - 1) {
                    const delay = Math.pow(2, i) * 1000;
                    console.warn(`Request failed, retrying in ${delay}ms...`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw error;
                }
            }
        }
    };


    // Function to extract column headers from an Excel file
    const extractColumns = (file, setColumns) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Get header row (first non-empty row)
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 0 });
                    if (json.length > 0) {
                        const headers = json[0];
                        setColumns(headers.filter(h => h && typeof h === 'string')); // Filter out null/empty headers
                        resolve(headers.filter(h => h && typeof h === 'string'));
                    } else {
                        setColumns([]);
                        resolve([]);
                    }
                } catch (err) {
                    console.error("Error reading file headers:", err);
                    setColumns([]);
                    resolve([]);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    };

    // --- SUB-COMPONENTS ---

    const Card = ({ children, className = '' }) => (
        <div className={`bg-white p-6 rounded-xl shadow-lg border border-gray-100 ${className}`}>
            {children}
        </div>
    );

    const FileList = ({ files, onRemove }) => (
        <ul className="space-y-2">
            {files.map((file, index) => (
                <li key={index} className="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                    <div className="flex items-center truncate">
                        <FileSpreadsheet className="text-blue-500 mr-2 flex-shrink-0" size={16} />
                        <span className="font-medium truncate">{file.name}</span>
                    </div>
                    <button 
                        onClick={() => onRemove(index)} 
                        className="text-gray-400 hover:text-red-500 transition duration-150"
                        title="Remove file"
                    >
                        <X size={16} />
                    </button>
                </li>
            ))}
        </ul>
    );

    const ColumnSelector = ({ label, value, onChange, options, name }) => (
        <div className="space-y-1">
            <label className="block text-sm font-medium text-gray-700">{label}</label>
            <select
                name={name}
                value={value}
                onChange={onChange}
                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
            >
                <option value="" disabled>Select a column</option>
                {options.map(col => (
                    <option key={col} value={col}>{col}</option>
                ))}
            </select>
            {value === '' && (
                <p className="text-xs text-red-500 flex items-center">
                    <AlertCircle size={14} className="mr-1" />
                    Selection required.
                </p>
            )}
        </div>
    );

    const StepIndicator = ({ step, currentStep, label }) => (
        <div className="flex flex-col items-center">
            <div className={`w-10 h-10 flex items-center justify-center rounded-full font-bold transition-all duration-300 ${
                currentStep > step 
                    ? 'bg-green-500 text-white' 
                    : currentStep === step 
                        ? 'bg-blue-600 text-white shadow-lg' 
                        : 'bg-gray-200 text-gray-500'
            }`}>
                {currentStep > step ? <CheckCircle size={20} /> : step}
            </div>
            <p className={`mt-2 text-sm text-center transition-colors duration-300 ${
                currentStep >= step ? 'text-gray-900 font-medium' : 'text-gray-500'
            }`}>
                {label}
            </p>
        </div>
    );

    const ProcessingOverlay = () => (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-4">
                <svg className="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p className="text-gray-700 font-medium">Reconciling data... This may take a moment.</p>
            </div>
        </div>
    );

    const ErrorDisplay = ({ error, clearError }) => (
        <div className="fixed inset-0 bg-red-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full space-y-4">
                <div className="flex items-center space-x-3">
                    <AlertCircle className="text-red-600" size={24} />
                    <h3 className="text-xl font-bold text-red-700">Reconciliation Failed</h3>
                </div>
                <p className="text-gray-700">An unexpected error occurred:</p>
                <div className="bg-red-50 p-4 rounded-lg text-sm text-red-800 break-words max-h-40 overflow-y-auto">
                    <pre>{error}</pre>
                </div>
                <button
                    onClick={clearError}
                    className="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200"
                >
                    Close and Return
                </button>
            </div>
        </div>
    );

    const MetricCard = ({ title, value, color, icon, description }) => (
        <div className={`p-5 rounded-xl shadow-md border ${color.border} bg-white transition duration-300 hover:shadow-lg`}>
            <div className="flex items-center justify-between">
                <p className="text-sm font-medium text-gray-500 truncate">{title}</p>
                {icon}
            </div>
            <div className="mt-1">
                <p className={`text-2xl font-bold ${color.text}`}>{value}</p>
            </div>
            <p className="mt-2 text-xs text-gray-400">{description}</p>
        </div>
    );

    const SummaryTable = ({ metrics, category }) => (
        <Card className="p-4 border-l-4 border-blue-500">
            <h4 className="font-semibold text-lg text-gray-800 mb-4">{category} Metrics</h4>
            <ul className="space-y-3">
                {metrics.map((metric, index) => (
                    <li key={index} className="flex justify-between items-center pb-2 border-b border-gray-100 last:border-b-0">
                        <span className="text-sm text-gray-600">{metric.title}</span>
                        <span className={`font-semibold text-sm ${metric.value.startsWith('-') ? 'text-red-600' : 'text-gray-800'}`}>
                            {metric.value}
                        </span>
                    </li>
                ))}
            </ul>
        </Card>
    );
    
    // --- MAIN APP ---

    const ReconciliationApp = () => {
        // --- State Management ---
        const [step, setStep] = useState(1);
        const [categoryAFiles, setCategoryAFiles] = useState([]);
        const [categoryBFiles, setCategoryBFiles] = useState([]);
        const [columnConfig, setColumnConfig] = useState({
            uniqueIdA: '',
            uniqueIdB: '',
            amountA: '',
            amountB: ''
        });
        const [availableColumnsA, setAvailableColumnsA] = useState([]);
        const [availableColumnsB, setAvailableColumnsB] = useState([]);
        const [processing, setProcessing] = useState(false);
        const [results, setResults] = useState(null);
        const [error, setError] = useState(null);
        const [selectedDownloads, setSelectedDownloads] = useState(['matched', 'unmatchedA', 'unmatchedB', 'summary']);


        // --- Handlers ---
        
        const removeFile = useCallback((category, index) => {
            if (category === 'A') {
                setCategoryAFiles(prev => prev.filter((_, i) => i !== index));
                if (categoryAFiles.length === 1) setAvailableColumnsA([]);
            } else {
                setCategoryBFiles(prev => prev.filter((_, i) => i !== index));
                if (categoryBFiles.length === 1) setAvailableColumnsB([]);
            }
            setResults(null); // Reset results on file change
        }, [categoryAFiles.length, categoryBFiles.length]);

        const handleFileUpload = async (e, category) => {
            const files = Array.from(e.target.files);
            if (category === 'A') {
                setCategoryAFiles(prev => [...prev, ...files]);
                // Extract columns only from the first file uploaded for selection
                if ([...categoryAFiles, ...files].length === files.length) {
                    await extractColumns(files[0], setAvailableColumnsA);
                }
            } else {
                setCategoryBFiles(prev => [...prev, ...files]);
                // Extract columns only from the first file uploaded for selection
                if ([...categoryBFiles, ...files].length === files.length) {
                    await extractColumns(files[0], setAvailableColumnsB);
                }
            }
            setResults(null);
        };

        const handleConfigChange = (e) => {
            const { name, value } = e.target;
            setColumnConfig(prev => ({ ...prev, [name]: value }));
        };

        const handleClearResults = () => {
            setResults(null);
            setDownloadedReports([]);
            setSelectedDownloads(['matched', 'unmatchedA', 'unmatchedB', 'summary']);
            setStep(1);
        };

        const isStep2Valid = useMemo(() => {
            return categoryAFiles.length > 0 && categoryBFiles.length > 0;
        }, [categoryAFiles, categoryBFiles]);

        const isStep3Valid = useMemo(() => {
            const { uniqueIdA, uniqueIdB, amountA, amountB } = columnConfig;
            return uniqueIdA && uniqueIdB && amountA && amountB;
        }, [columnConfig]);


        // --- Gemini API Call / Reconciliation Logic (Simulated) ---

        const reconcileData = useCallback(async () => {
            if (!isStep3Valid) return;

            setProcessing(true);
            setError(null);
            setResults(null);
            
            // This is where you would normally call the model to process the files.
            // Since we cannot read Excel data directly for the LLM, we will simulate the reconciliation process.
            
            // Simulation of file reading and data preparation (highly simplified)
            const dataA = categoryAFiles.map(f => ({ name: f.name, size: f.size }));
            const dataB = categoryBFiles.map(f => ({ name: f.name, size: f.size }));
            const config = columnConfig;

            // Prepare prompt for Gemini (Conceptual)
            const systemPrompt = "You are an expert financial reconciliation engine. Given the data schemas and files, perform a two-way reconciliation based on the unique ID and amount columns. Generate a JSON report with summary metrics and all matched/unmatched records.";
            
            // The actual data upload/processing part is complex and typically done server-side.
            // We'll use a local delay and a mock response to simulate the process.
            
            try {
                // Mock API Call Delay
                await new Promise(resolve => setTimeout(resolve, 3000)); 

                const mockResponse = generateMockReconciliationResult(dataA, dataB, config);
                setResults(mockResponse);
                setStep(4);

            } catch (err) {
                console.error("Reconciliation Error:", err);
                setError(`Reconciliation failed. Details: ${err.message || 'Unknown error during processing.'}`);
            } finally {
                setProcessing(false);
            }

        }, [isStep3Valid, categoryAFiles, categoryBFiles, columnConfig]);

        // Mock Data Generator for Demonstration
        const generateMockReconciliationResult = (dataA, dataB, config) => {
            const numA = dataA.length * 100;
            const numB = dataB.length * 120;
            const matchedCount = Math.floor(Math.min(numA, numB) * 0.85);
            const totalAmountA = numA * 1500;
            const totalAmountB = numB * 1600;
            const matchedAmount = Math.min(totalAmountA, totalAmountB) * 0.9;
            const unmatchedA = numA - matchedCount;
            const unmatchedB = numB - matchedCount;

            // Simplified Mock Data for the table/reports
            const matchedRecords = Array(matchedCount).fill(0).map((_, i) => ({
                Composite_ID: `TXN-MATCH-${i+1}`,
                Amount: (matchedAmount / matchedCount).toFixed(2),
                File_A_Ref: `A-${i+1}`,
                File_B_Ref: `B-${i+1}`,
                __Source_File: 'Combined',
                __Original_Row_Index: i + 2,
            }));
            
            const unmatchedRecordsA = Array(unmatchedA).fill(0).map((_, i) => ({
                Composite_ID: `TXN-UMA-${i+1}`,
                Amount: ((totalAmountA - matchedAmount) / unmatchedA).toFixed(2),
                File_A_Ref: `A-${matchedCount + i + 1}`,
                __Source_File: dataA[0]?.name || 'File A',
                __Original_Row_Index: matchedCount + i + 2,
            }));
            
            const unmatchedRecordsB = Array(unmatchedB).fill(0).map((_, i) => ({
                Composite_ID: `TXN-UMB-${i+1}`,
                Amount: ((totalAmountB - matchedAmount) / unmatchedB).toFixed(2),
                File_B_Ref: `B-${matchedCount + i + 1}`,
                __Source_File: dataB[0]?.name || 'File B',
                __Original_Row_Index: matchedCount + i + 2,
            }));

            // Summary Metrics for the cards
            const summaryMetricsA = [
                { title: `Total Records in ${dataA[0]?.name || 'File A'}`, value: numA.toLocaleString() },
                { title: 'Total Matched Records', value: matchedCount.toLocaleString() },
                { title: 'Total Unmatched Records', value: unmatchedA.toLocaleString() },
                { title: 'Total Amount', value: totalAmountA.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) },
            ];

            const summaryMetricsB = [
                { title: `Total Records in ${dataB[0]?.name || 'File B'}`, value: numB.toLocaleString() },
                { title: 'Total Matched Records', value: matchedCount.toLocaleString() },
                { title: 'Total Unmatched Records', value: unmatchedB.toLocaleString() },
                { title: 'Total Amount', value: totalAmountB.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) },
            ];
            
            const summaryMetricsReconciliation = [
                { title: 'Matched Count', value: matchedCount.toLocaleString(), color: { text: 'text-green-600', border: 'border-green-300' } },
                { title: 'Unmatched A Count', value: unmatchedA.toLocaleString(), color: { text: 'text-red-600', border: 'border-red-300' } },
                { title: 'Unmatched B Count', value: unmatchedB.toLocaleString(), color: { text: 'text-yellow-600', border: 'border-yellow-300' } },
                { title: 'Difference (A - B)', value: (totalAmountA - totalAmountB).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }), color: { text: 'text-blue-600', border: 'border-blue-300' } },
            ];


            return {
                summaryMetricsReconciliation,
                summaryMetricsA,
                summaryMetricsB,
                matchedRecords,
                unmatchedRecordsA,
                unmatchedRecordsB,
            };
        };

        const downloadReports = () => {
            if (!results || selectedDownloads.length === 0) return;
            
            const workbook = XLSX.utils.book_new();

            const reportsMap = {
                matched: { sheetName: 'Matched Records', data: results.matchedRecords },
                unmatchedA: { sheetName: 'Unmatched Category A', data: results.unmatchedRecordsA },
                unmatchedB: { sheetName: 'Unmatched Category B', data: results.unmatchedRecordsB },
                summary: { sheetName: 'Summary Metrics', data: [
                    { Report: 'Category A Total Records', Value: results.summaryMetricsA[0].value },
                    { Report: 'Category B Total Records', Value: results.summaryMetricsB[0].value },
                    { Report: 'Total Matched Records', Value: results.summaryMetricsReconciliation[0].value },
                    { Report: 'Total Unmatched A Records', Value: results.summaryMetricsReconciliation[1].value },
                    { Report: 'Total Unmatched B Records', Value: results.summaryMetricsReconciliation[2].value },
                    { Report: 'Total Amount Difference (A - B)', Value: results.summaryMetricsReconciliation[3].value },
                ]},
            };
            
            selectedDownloads.forEach(key => {
                if (reportsMap[key]) {
                    const { sheetName, data } = reportsMap[key];
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                }
            });

            // Write and download the file
            const fileName = `Reconciliation_Report_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);

            // Update downloadedReports state
            setDownloadedReports(prev => {
                const newDownloads = new Set([...prev, ...selectedDownloads]);
                return Array.from(newDownloads);
            });
        };

        const handleDownloadToggle = (key) => {
            setSelectedDownloads(prev => {
                if (prev.includes(key)) {
                    return prev.filter(k => k !== key);
                } else {
                    return [...prev, key];
                }
            });
        };
        
        const [downloadedReports, setDownloadedReports] = useState([]);
        
        const DownloadToggle = ({ reportKey, label }) => {
            const isSelected = selectedDownloads.includes(reportKey);
            const isDownloaded = downloadedReports.includes(reportKey);
            
            return (
                <label 
                    className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition duration-200 ${
                        isSelected 
                            ? 'bg-blue-100 border-blue-400' 
                            : 'bg-white border-gray-300 hover:bg-gray-50'
                    } border shadow-sm`}
                >
                    <div className="flex items-center">
                        <input
                            type="checkbox"
                            checked={isSelected}
                            onChange={() => handleDownloadToggle(reportKey)}
                            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <span className="ml-3 text-sm font-medium text-gray-700">{label}</span>
                    </div>
                    {isDownloaded && <span className="text-xs text-green-600 font-semibold flex items-center"><CheckCircle size={14} className="mr-1"/> Downloaded</span>}
                </label>
            );
        };


        // --- Step Components ---

        const Step1 = () => (
            <Card>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Step 1: Upload Data Files</h2>
                <p className="text-gray-600 mb-6">Upload the files for the two categories you wish to reconcile. Files should be in CSV or Excel format.</p>

                <div className="grid md:grid-cols-2 gap-8">
                    {/* Category A Upload */}
                    <div>
                        <h3 className="text-xl font-semibold mb-3 text-blue-600">Category A Files (Source)</h3>
                        <input
                            id="fileA"
                            type="file"
                            accept=".csv, .xlsx"
                            multiple
                            onChange={(e) => handleFileUpload(e, 'A')}
                            className="hidden"
                        />
                        <label 
                            htmlFor="fileA" 
                            className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 transition-colors duration-200 shadow-sm"
                        >
                            <Upload size={24} className="text-blue-500 mb-2" />
                            <p className="text-sm font-medium text-blue-700">Click to upload or drag & drop</p>
                            <p className="text-xs text-blue-500">Supports multiple files (CSV, XLSX)</p>
                        </label>
                        
                        <div className="mt-4">
                            <FileList 
                                files={categoryAFiles} 
                                onRemove={(index) => removeFile('A', index)} 
                            />
                        </div>
                    </div>

                    {/* Category B Upload */}
                    <div>
                        <h3 className="text-xl font-semibold mb-3 text-green-600">Category B Files (Target)</h3>
                        <input
                            id="fileB"
                            type="file"
                            accept=".csv, .xlsx"
                            multiple
                            onChange={(e) => handleFileUpload(e, 'B')}
                            className="hidden"
                        />
                        <label 
                            htmlFor="fileB" 
                            className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-green-300 rounded-lg cursor-pointer bg-green-50 hover:bg-green-100 transition-colors duration-200 shadow-sm"
                        >
                            <Upload size={24} className="text-green-500 mb-2" />
                            <p className="text-sm font-medium text-green-700">Click to upload or drag & drop</p>
                            <p className="text-xs text-green-500">Supports multiple files (CSV, XLSX)</p>
                        </label>
                        
                        <div className="mt-4">
                            <FileList 
                                files={categoryBFiles} 
                                onRemove={(index) => removeFile('B', index)} 
                            />
                        </div>
                    </div>
                </div>

                <div className="flex justify-end mt-8">
                    <button 
                        onClick={() => setStep(2)} 
                        disabled={!isStep2Valid}
                        className={`px-8 py-3 rounded-lg font-semibold transition duration-200 ${
                            isStep2Valid 
                                ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                    >
                        Next: Configure Columns
                    </button>
                </div>
            </Card>
        );

        const Step2 = () => (
            <Card>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Step 2: Define Reconciliation Keys</h2>
                <p className="text-gray-600 mb-6">Select the unique ID and amount columns for each category. These are the keys the system will use for matching.</p>
                
                <div className="grid md:grid-cols-2 gap-8">
                    {/* Category A Configuration */}
                    <div className="space-y-4 p-4 border border-blue-200 rounded-lg bg-blue-50">
                        <h3 className="text-xl font-semibold text-blue-700">Category A Columns</h3>
                        <ColumnSelector
                            label="Unique ID Column (A)"
                            name="uniqueIdA"
                            value={columnConfig.uniqueIdA}
                            onChange={handleConfigChange}
                            options={availableColumnsA}
                        />
                        <ColumnSelector
                            label="Amount Column (A)"
                            name="amountA"
                            value={columnConfig.amountA}
                            onChange={handleConfigChange}
                            options={availableColumnsA}
                        />
                        <p className="text-sm text-blue-600 mt-2">
                            Files: {categoryAFiles.map(f => f.name).join(', ')}
                        </p>
                    </div>

                    {/* Category B Configuration */}
                    <div className="space-y-4 p-4 border border-green-200 rounded-lg bg-green-50">
                        <h3 className="text-xl font-semibold text-green-700">Category B Columns</h3>
                        <ColumnSelector
                            label="Unique ID Column (B)"
                            name="uniqueIdB"
                            value={columnConfig.uniqueIdB}
                            onChange={handleConfigChange}
                            options={availableColumnsB}
                        />
                        <ColumnSelector
                            label="Amount Column (B)"
                            name="amountB"
                            value={columnConfig.amountB}
                            onChange={handleConfigChange}
                            options={availableColumnsB}
                        />
                        <p className="text-sm text-green-600 mt-2">
                            Files: {categoryBFiles.map(f => f.name).join(', ')}
                        </p>
                    </div>
                </div>

                <div className="flex justify-between mt-8">
                    <button 
                        onClick={() => setStep(1)} 
                        className="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-200"
                    >
                        Back: Upload Files
                    </button>
                    <button 
                        onClick={() => setStep(3)} 
                        disabled={!isStep3Valid}
                        className={`px-8 py-3 rounded-lg font-semibold transition duration-200 ${
                            isStep3Valid 
                                ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                    >
                        Next: Review & Reconcile
                    </button>
                </div>
            </Card>
        );

        const Step3 = () => (
            <Card>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Step 3: Review and Run</h2>
                <p className="text-gray-600 mb-6">Confirm the reconciliation setup and initiate the process. Review the column selections below.</p>
                
                <div className="grid md:grid-cols-2 gap-6 mb-8">
                    {/* Review Configuration */}
                    <div className="p-5 border border-blue-200 rounded-lg bg-blue-50">
                        <h3 className="text-lg font-semibold text-blue-700 mb-3">Category A (Source)</h3>
                        <p className="text-sm"><span className="font-medium">Files:</span> {categoryAFiles.length} file(s)</p>
                        <p className="text-sm"><span className="font-medium">Unique ID:</span> <span className="font-mono bg-blue-100 p-1 rounded text-blue-800">{columnConfig.uniqueIdA}</span></p>
                        <p className="text-sm"><span className="font-medium">Amount:</span> <span className="font-mono bg-blue-100 p-1 rounded text-blue-800">{columnConfig.amountA}</span></p>
                    </div>
                    
                    <div className="p-5 border border-green-200 rounded-lg bg-green-50">
                        <h3 className="text-lg font-semibold text-green-700 mb-3">Category B (Target)</h3>
                        <p className="text-sm"><span className="font-medium">Files:</span> {categoryBFiles.length} file(s)</p>
                        <p className="text-sm"><span className="font-medium">Unique ID:</span> <span className="font-mono bg-green-100 p-1 rounded text-green-800">{columnConfig.uniqueIdB}</span></p>
                        <p className="text-sm"><span className="font-medium">Amount:</span> <span className="font-mono bg-green-100 p-1 rounded text-green-800">{columnConfig.amountB}</span></p>
                    </div>
                </div>
                
                <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-8">
                    <p className="text-sm text-yellow-800 flex items-start">
                        <AlertCircle size={18} className="mr-2 mt-0.5 flex-shrink-0 text-yellow-600" />
                        <span>
                            **Data Note:** The reconciliation process will combine all files within each category and match records based on the selected ID and Amount columns.
                        </span>
                    </p>
                </div>

                <div className="flex justify-between mt-8">
                    <button 
                        onClick={() => setStep(2)} 
                        className="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-200"
                    >
                        Back: Configure Columns
                    </button>
                    <button 
                        onClick={reconcileData} 
                        className="px-8 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 shadow-xl flex items-center"
                    >
                        <CheckCircle size={20} className="mr-2" />
                        Run Reconciliation
                    </button>
                </div>
            </Card>
        );

        const ResultsView = ({ results, config, clearResults, downloadedReports, setDownloadedReports }) => {
            
            return (
                <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800 flex items-center justify-between">
                        Reconciliation Complete <CheckCircle size={30} className="text-green-500" />
                    </h2>
                    <p className="text-gray-600">The reconciliation process has finished. Review the summary metrics and download the detailed reports below.</p>

                    {/* Summary Metrics */}
                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {results.summaryMetricsReconciliation.map((metric, index) => (
                            <MetricCard 
                                key={index}
                                title={metric.title}
                                value={metric.value}
                                color={metric.color}
                                icon={<FileSpreadsheet size={20} className={metric.color.text} />}
                                description={index === 3 ? "Difference between Category A and B totals" : "Total number of records"}
                            />
                        ))}
                    </div>

                    {/* Download Controls */}
                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-4">
                        <h3 className="font-bold text-xl mb-4 text-gray-800 flex items-center">
                            <Download size={24} className="mr-3 text-blue-600" /> Download Reports
                        </h3>
                        <div className="grid sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <DownloadToggle reportKey="matched" label="Matched Records" />
                            <DownloadToggle reportKey="unmatchedA" label={`Unmatched A (${config.uniqueIdA})`} />
                            <DownloadToggle reportKey="unmatchedB" label={`Unmatched B (${config.uniqueIdB})`} />
                            <DownloadToggle reportKey="summary" label="Summary Metrics" />
                        </div>
                        
                        <button 
                            onClick={downloadReports} 
                            disabled={selectedDownloads.length === 0}
                            className={`w-full py-3 rounded-lg font-semibold transition duration-200 flex items-center justify-center shadow-md ${
                                selectedDownloads.length > 0 
                                    ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                        >
                            <Download size={20} className="mr-2" />
                            Download Selected ({selectedDownloads.length}) Report{selectedDownloads.length !== 1 ? 's' : ''}
                        </button>
                    </div>


                    {/* Structured Summary Tables */}
                    <div className="bg-gray-50 rounded-lg p-6">
                        <h3 className="font-bold text-xl mb-4 text-gray-800">Detailed Structured Summary</h3>
                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Category A Summary */}
                            <SummaryTable metrics={results.summaryMetricsA} category="Category A" />
                            
                            {/* Category B Summary */}
                            <SummaryTable metrics={results.summaryMetricsB} category="Category B" />
                        </div>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-sm text-blue-800 flex items-start">
                            <Info size={18} className="mr-2 mt-0.5 flex-shrink-0 text-blue-600" />
                            <span>
                                **Traceability Note:** The downloaded reports include essential metadata like **`Composite_ID`** (for the match key), **`__Source_File`**, and **`__Original_Row_Index`** (for the exact row number in the source file) to help you trace the transaction back to its origin.
                            </span>
                        </p>
                    </div>
                    <div className="text-center pt-4">
                        <button 
                            onClick={clearResults} 
                            className="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-200"
                        >
                            Start New Reconciliation
                        </button>
                    </div>
                </div>
            );
        };


        // --- Main Render ---
        return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
                <div className="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
                    {/* Header / Step Navigator */}
                    <nav className="flex justify-between items-center mb-10">
                        <StepIndicator step={1} currentStep={step} label="Upload Files" />
                        <div className={`flex-1 h-1 mx-4 transition-colors duration-300 ${step > 1 ? 'bg-blue-500' : 'bg-gray-300'}`}></div>
                        <StepIndicator step={2} currentStep={step} label="Configure Keys" />
                        <div className={`flex-1 h-1 mx-4 transition-colors duration-300 ${step > 2 ? 'bg-blue-500' : 'bg-gray-300'}`}></div>
                        <StepIndicator step={3} currentStep={step} label="Run & Review" />
                        <div className={`flex-1 h-1 mx-4 transition-colors duration-300 ${step > 3 ? 'bg-blue-500' : 'bg-gray-300'}`}></div>
                        <StepIndicator step={4} currentStep={step} label="Results" />
                    </nav>

                    {/* Content Area */}
                    <div className="mt-8">
                        {step === 1 && <Step1 />}
                        {step === 2 && <Step2 />}
                        {step === 3 && <Step3 />}
                        {step === 4 && results && (
                            <ResultsView
                                results={results}
                                config={columnConfig}
                                clearResults={handleClearResults}
                                downloadedReports={downloadedReports}
                                setDownloadedReports={setDownloadedReports}
                            />
                        )}
                        {/* Only one of the steps above will render */}
                    </div>
                </div>
                
                {/* Overlays are siblings to the main card div, which is wrapped by the outer div */}
                {processing && <ProcessingOverlay />}
                {error && <ErrorDisplay error={error} clearError={() => setError(null)} />}
            </div>
        );
    };
    
    // Render the React application
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<ReconciliationApp />);

    </script>
</body>
</html>
